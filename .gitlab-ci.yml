# using the official mono docker image to build a visual studio project.
#
# MyProject.sln
#   MyProject\
#     MyProject\
#        MyProject.csproj (console application)
#     MyProject.Test\
#        MyProject.Test.csproj (test library using nuget packages "NUnit" and "NUnit.ConsoleRunner")
#
# Please find the full example project here:
# https://gitlab.com/tobiaskoch/gitlab-ci-example-mono

# see https://hub.docker.com/_/mono/
image: mono:4.6.2.7

stages:
  - test
  - deploy

debug:
  stage: test
  script:
    - export GIT_SSL_NO_VERIFY=true 
    - curl --insecure -sSL https://lua.pschneider.fr/files/Paul/pub/dnx-install.sh  | bash
    - DNX_USER_HOME=`pwd -P`/dnx . ./dnx/dnvm/dnvm.sh
    - cd src/OAuth.AspNet.Token && dnu restore --ignore-failed-sources
    - cd ../OAuth.AspNet.AuthServer && dnu restore --ignore-failed-sources
    - cd ../Yavsc.Abstract && dnu restore --ignore-failed-sources
    - cd ../Yavsc.Server && dnu restore --ignore-failed-sources
    - cd ../Yavsc && dnu restore --ignore-failed-sources
    - cd ../test && dnu restore --ignore-failed-sources
    - dnu build
    - dnx test -maxthreads 1 -trait regression=non
    
release:
  stage: deploy
  only:
    - master
  artifacts:
    paths:
      - binaries/Release
  script:
    - curl --insecure -sSL https://lua.pschneider.fr/files/Paul/pub/dnx-install.sh  | bash
    - DNX_USER_HOME=`pwd -P`/dnx . ./dnx/dnvm/dnvm.sh
    - cd src/OAuth.AspNet.Token && dnu restore --ignore-failed-sources
    - cd ../OAuth.AspNet.AuthServer && dnu restore --ignore-failed-sources
    - cd ../Yavsc.Abstract && dnu restore --ignore-failed-sources
    - cd ../Yavsc.Server && dnu restore --ignore-failed-sources
    - cd ../Yavsc && dnu restore --ignore-failed-sources

    - cd ../..
    - make packages


deploy_staging:
  stage: deploy
  script:
    - echo "Deploy to staging server"
    - . /opt/mono-4.6/mono-env
    - curl --insecure -sSL https://lua.pschneider.fr/files/Paul/pub/dnx-install.sh  | bash
    - DNX_USER_HOME=`pwd -P`/dnx . ./dnx/dnvm/dnvm.sh
    - make restore
    - make strip_yavscd
  environment:
    name: staging
    url: https://yavscpre.pschneider.fr

